const { S3Client, PutObjectCommand, DeleteObjectCommand } = require('@aws-sdk/client-s3');
const s3 = new S3Client();

exports.handler = async (event) => {
    const e = process.env;

    if (event.action === 'destroy') {
        try { await s3.send(new DeleteObjectCommand({ Bucket: e.BUCKET, Key: 'index.html' })); } catch (err) {}
        try { await s3.send(new DeleteObjectCommand({ Bucket: e.BUCKET, Key: 'script.js' })); } catch (err) {}
        return { status: 'deleted' };
    }

    const logo = e.LOGO ? '<img style="height:32px" src="' + e.LOGO + '" alt="' + e.COMPANY + '">' : '';
    const yr = new Date().getFullYear();
    const html = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>' + e.COMPANY + ' - Registration</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;background:#f2f3f3;color:#16191f;min-height:100vh}.top-bar{background:' + e.COLOR2 + ';height:56px;display:flex;align-items:center;padding:0 24px}.top-bar-brand{display:flex;align-items:center;gap:12px;text-decoration:none}.top-bar-brand span{color:#fff;font-size:18px;font-weight:700}.main-content{max-width:560px;margin:48px auto;padding:0 24px}.page-header{margin-bottom:24px}.page-header h1{font-size:28px;font-weight:700;margin-bottom:8px}.page-header p{font-size:14px;color:#545b64;line-height:1.6}.card{background:#fff;border:1px solid #d5dbdb;border-radius:8px;padding:32px}.card-header{font-size:18px;font-weight:700;padding-bottom:16px;margin-bottom:24px;border-bottom:1px solid #eaeded}.ff{margin-bottom:20px}.ff label{display:block;font-size:14px;font-weight:700;margin-bottom:6px}.ff input{width:100%;padding:8px 12px;font-size:14px;font-family:inherit;border:1px solid #aab7b8;border-radius:4px;outline:none}.ff input:focus{border-color:' + e.COLOR1 + ';box-shadow:0 0 0 1px ' + e.COLOR1 + '}.req{color:#d13212}.alert{padding:12px 16px;border-radius:4px;font-size:14px;margin-bottom:20px}.alert-info{background:#f1faff;border:1px solid ' + e.COLOR1 + ';color:' + e.COLOR1 + '}.alert-success{background:#f2f8f0;border:1px solid #1d8102;color:#1d8102}.alert-danger{background:#fdf3f1;border:1px solid #d13212;color:#d13212}.btn{background:' + e.COLOR1 + ';color:#fff;border:none;padding:10px 20px;font-size:14px;font-family:inherit;font-weight:700;border-radius:4px;cursor:pointer;width:100%}.btn:hover{opacity:.9}.btn:disabled{opacity:.5;cursor:not-allowed}.divider{height:1px;background:#eaeded;margin:24px 0}.footer{text-align:center;padding:24px;font-size:12px;color:#545b64}</style></head><body><div class="top-bar"><a class="top-bar-brand" href="#">' + logo + '<span>' + e.COMPANY + '</span></a></div><div class="main-content"><div class="page-header"><h1>Welcome to ' + e.COMPANY + '</h1><p>' + e.WELCOME + '</p></div><div id="alert"></div><div class="card"><div class="card-header">Account details</div><form id="registrationForm"><div class="ff"><label>Company name <span class="req">*</span></label><input type="text" name="companyName" required></div><div class="ff"><label>Contact person <span class="req">*</span></label><input type="text" name="contactPerson" required></div><div class="ff"><label>Contact phone <span class="req">*</span></label><input type="tel" name="contactPhone" required></div><div class="ff"><label>Email address <span class="req">*</span></label><input type="email" name="contactEmail" required></div><div class="divider"></div><button class="btn" type="submit">Complete registration</button></form></div><div class="footer">&copy; ' + yr + ' ' + e.COMPANY + '</div></div><script src="script.js"></script></body></html>';

    const js = 'const API="' + e.API_URL + '";window.addEventListener("DOMContentLoaded",function(){var t=new URLSearchParams(window.location.search).get("x-amzn-marketplace-token");t||showAlert("info","This page is accessed via AWS Marketplace. Registration works once customers subscribe through AWS Marketplace.")});document.getElementById("registrationForm").addEventListener("submit",async function(ev){ev.preventDefault();var t=new URLSearchParams(window.location.search).get("x-amzn-marketplace-token");if(!t){showAlert("error","Invalid registration link. Please use the link from AWS Marketplace.");return}var f=new FormData(ev.target);var d={regToken:t,companyName:f.get("companyName"),contactPerson:f.get("contactPerson"),contactPhone:f.get("contactPhone"),contactEmail:f.get("contactEmail")};var b=ev.target.querySelector("button[type=submit]");var o=b.textContent;b.disabled=true;b.textContent="Registering...";try{var r=await fetch(API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)});var j=await r.json();r.ok?showAlert("success","Registration successful! We will be in touch to provide you access to the SaaS platform."):showAlert("error",j.error||"Registration failed.")}catch(e){showAlert("error","Network error. Please try again.")}finally{b.disabled=false;b.textContent=o}});function showAlert(t,m){document.getElementById("alert").innerHTML="<div class=\\"alert alert-"+(t==="success"?"success":t==="error"?"danger":"info")+"\\" role=\\"alert\\">"+m+"</div>"}';

    await s3.send(new PutObjectCommand({ Bucket: e.BUCKET, Key: 'index.html', Body: html, ContentType: 'text/html' }));
    await s3.send(new PutObjectCommand({ Bucket: e.BUCKET, Key: 'script.js', Body: js, ContentType: 'application/javascript' }));
    return { status: 'deployed' };
};
