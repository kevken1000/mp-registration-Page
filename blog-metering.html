<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrating Usage Metering with Your AWS Marketplace SaaS Product | AWS Marketplace Blog</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Amazon Ember', 'Helvetica Neue', Helvetica, Arial, sans-serif; background: #f2f3f3; color: #16191f; line-height: 1.6; }
        .top-nav { background: #232f3e; height: 50px; display: flex; align-items: center; padding: 0 24px; position: sticky; top: 0; z-index: 100; }
        .top-nav-inner { max-width: 1200px; margin: 0 auto; width: 100%; display: flex; align-items: center; gap: 24px; }
        .aws-logo { color: #ff9900; font-size: 18px; font-weight: 700; text-decoration: none; letter-spacing: -0.5px; }
        .nav-links { display: flex; gap: 20px; }
        .nav-links a { color: #d5dbdb; font-size: 13px; text-decoration: none; }
        .nav-links a:hover { color: #fff; }
        .blog-header-bar { background: #fff; border-bottom: 1px solid #d5dbdb; padding: 12px 24px; }
        .blog-header-inner { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; gap: 12px; }
        .blog-category { font-size: 14px; color: #0073bb; font-weight: 600; text-decoration: none; }
        .blog-category:hover { text-decoration: underline; }
        .main-layout { max-width: 1200px; margin: 0 auto; display: flex; gap: 40px; padding: 32px 24px; }
        .content-area { flex: 1; min-width: 0; }
        .sidebar { width: 280px; flex-shrink: 0; }
        .article { background: #fff; border: 1px solid #d5dbdb; border-radius: 2px; padding: 40px 48px; }
        .article-meta { font-size: 13px; color: #545b64; margin-bottom: 8px; }
        .article-meta a { color: #0073bb; text-decoration: none; }
        .article-meta a:hover { text-decoration: underline; }
        .article h1 { font-size: 32px; font-weight: 700; line-height: 1.25; margin-bottom: 16px; color: #16191f; }
        .article-byline { font-size: 13px; color: #545b64; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #eaeded; }
        .article-byline a { color: #0073bb; text-decoration: none; }
        .article-body p { font-size: 15px; line-height: 1.75; margin-bottom: 16px; color: #16191f; }
        .article-body h2 { font-size: 24px; font-weight: 700; margin: 36px 0 16px; color: #16191f; }
        .article-body h3 { font-size: 18px; font-weight: 700; margin: 28px 0 12px; color: #16191f; }
        .article-body a { color: #0073bb; text-decoration: none; }
        .article-body a:hover { text-decoration: underline; }
        .article-body ul, .article-body ol { margin: 0 0 16px 24px; font-size: 15px; line-height: 1.75; }
        .article-body li { margin-bottom: 4px; }
        .article-body strong { font-weight: 700; }
        .article-body img { max-width: 100%; height: auto; margin: 20px 0; border: 1px solid #d5dbdb; border-radius: 2px; }
        .article-body .figure-caption { font-size: 13px; color: #545b64; font-style: italic; text-align: center; margin: -12px 0 24px; }
        .article-body pre { background: #1b2a3d; color: #d5dbdb; padding: 16px 20px; border-radius: 4px; overflow-x: auto; margin: 16px 0; font-size: 13px; line-height: 1.6; }
        .article-body code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 13px; }
        .article-body p code, .article-body li code, .article-body td code { background: #f2f3f3; padding: 2px 6px; border-radius: 3px; color: #d13212; font-size: 13px; }
        .article-body table { width: 100%; border-collapse: collapse; margin: 16px 0 24px; font-size: 14px; }
        .article-body th { background: #fafafa; text-align: left; padding: 10px 14px; border: 1px solid #d5dbdb; font-weight: 700; font-size: 13px; color: #545b64; text-transform: uppercase; letter-spacing: 0.5px; }
        .article-body td { padding: 10px 14px; border: 1px solid #d5dbdb; vertical-align: top; }
        .callout { background: #f1faff; border-left: 4px solid #0073bb; padding: 16px 20px; margin: 20px 0; border-radius: 0 4px 4px 0; }
        .callout p { margin-bottom: 0; font-size: 14px; }
        .callout-tip { background: #f2f8f0; border-left-color: #1d8102; }
        .callout-warn { background: #fef8f1; border-left-color: #ff9900; }
        .sidebar-card { background: #fff; border: 1px solid #d5dbdb; border-radius: 2px; padding: 20px; margin-bottom: 20px; }
        .sidebar-card h3 { font-size: 14px; font-weight: 700; color: #16191f; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .sidebar-card ul { list-style: none; }
        .sidebar-card li { margin-bottom: 10px; }
        .sidebar-card a { color: #0073bb; font-size: 14px; text-decoration: none; line-height: 1.4; display: block; }
        .sidebar-card a:hover { text-decoration: underline; }
        .sidebar-tag { display: inline-block; background: #f2f3f3; color: #545b64; font-size: 12px; padding: 4px 10px; border-radius: 3px; margin: 0 6px 6px 0; text-decoration: none; }
        .sidebar-tag:hover { background: #d5dbdb; text-decoration: none; }
        .author-box { margin-top: 36px; padding-top: 24px; border-top: 1px solid #eaeded; }
        .author-box h3 { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
        .author-entry { display: flex; gap: 16px; align-items: flex-start; margin-bottom: 16px; }
        .author-avatar { width: 64px; height: 64px; background: #232f3e; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #ff9900; font-weight: 700; }
        .author-info .author-name { font-size: 15px; font-weight: 700; color: #16191f; }
        .author-info .author-title { font-size: 13px; color: #545b64; margin-top: 4px; line-height: 1.5; }
        .blog-footer { background: #232f3e; color: #d5dbdb; padding: 40px 24px; margin-top: 48px; }
        .footer-inner { max-width: 1200px; margin: 0 auto; text-align: center; font-size: 13px; }
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .article { padding: 24px; }
            .main-layout { padding: 16px; }
        }
    </style>
</head>
<body>
    <nav class="top-nav">
        <div class="top-nav-inner">
            <a href="#" class="aws-logo">aws</a>
            <div class="nav-links">
                <a href="#">Contact Us</a>
                <a href="#">Support</a>
                <a href="#">English ▾</a>
                <a href="#">My Account ▾</a>
            </div>
        </div>
    </nav>

    <div class="blog-header-bar">
        <div class="blog-header-inner">
            <a href="#" class="blog-category">AWS Marketplace Blog</a>
        </div>
    </div>

    <div class="main-layout">
        <main class="content-area">
            <article class="article">
                <div class="article-meta">
                    <a href="#">AWS Marketplace</a> &middot; <a href="#">SaaS</a> &middot; <a href="#">Technical How-to</a>
                </div>
                <h1>Integrating Usage Metering with Your AWS Marketplace SaaS Product</h1>
                <div class="article-byline">
                    by <a href="#">Kevin Kennedy</a> | on <time>13 FEB 2026</time> | in <a href="#">AWS Marketplace</a>, <a href="#">Amazon DynamoDB</a>, <a href="#">AWS Lambda</a> | <a href="#">Permalink</a> &middot; <a href="#">Comments</a> &middot; <a href="#">Share</a>
                </div>

                <div class="article-body">

                    <p>If your SaaS product on <a href="https://aws.amazon.com/marketplace">AWS Marketplace</a> uses usage-based pricing, you need to report customer usage to AWS Marketplace through the <a href="https://docs.aws.amazon.com/marketplacemetering/latest/APIReference/API_BatchMeterUsage.html">BatchMeterUsage</a> API. This is how AWS Marketplace knows what to charge your customers.</p>

                    <p>In our companion post, <a href="blog.html">Get Your AWS Marketplace SaaS Registration Page Live in Minutes</a>, we introduced a sample solution that deploys a complete registration page infrastructure using a single CloudFormation template. That template includes a metering pipeline out of the box. In this post, we cover how the metering pipeline works and how to integrate it with your application.</p>

                    <h2>When do you need metering?</h2>

                    <table>
                        <thead>
                            <tr><th>Listing type</th><th>Metering required?</th><th>Use case</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>SaaS Subscription</td><td>Yes</td><td>Usage-based pricing (pay for what you use)</td></tr>
                            <tr><td>SaaS Contract with Consumption</td><td>Yes</td><td>Upfront commitment plus overage charges</td></tr>
                            <tr><td>SaaS Contract</td><td>No</td><td>Fixed upfront pricing only</td></tr>
                        </tbody>
                    </table>

                    <p>If your product is contract-only, the metering resources are deployed but sit idle at negligible cost. You can ignore this post and come back to it if you add a usage-based component later.</p>

                    <h2>How the metering pipeline works</h2>

                    <p>The pipeline runs automatically once deployed. Here is the flow:</p>

                    <ol>
                        <li>Your application writes usage records to the <strong>Metering Records</strong> DynamoDB table.</li>
                        <li>Every hour, an Amazon CloudWatch Events rule triggers the <strong>Metering Job</strong> Lambda function.</li>
                        <li>The Metering Job queries for all records where <code>metering_pending</code> is <code>"true"</code>, aggregates them by customer, product code, and dimension, and sends each batch to an Amazon SQS queue.</li>
                        <li>The <strong>Metering Processor</strong> Lambda function picks up messages from the queue and calls <code>BatchMeterUsage</code> for each batch.</li>
                        <li>Each record is updated with the API response. Cumulative totals are tracked on the subscriber record in the Subscribers table.</li>
                    </ol>

                    <div class="callout">
                        <p>You only need to do one thing: write usage records to the Metering Records table. The rest is handled automatically.</p>
                    </div>

                    <h2>Writing usage records</h2>

                    <p>Each usage record goes into the <code>&lt;StackName&gt;-MeteringRecordsV2</code> DynamoDB table. Here are the required fields:</p>

                    <table>
                        <thead>
                            <tr><th>Field</th><th>Type</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><code>customerAWSAccountId</code></td><td>String</td><td>The customer's AWS account ID (from registration)</td></tr>
                            <tr><td><code>productCode</code></td><td>String</td><td>Your AWS Marketplace product code</td></tr>
                            <tr><td><code>create_timestamp</code></td><td>Number</td><td>Unix timestamp in milliseconds</td></tr>
                            <tr><td><code>dimension</code></td><td>String</td><td>Your pricing dimension (case-sensitive, must match your listing)</td></tr>
                            <tr><td><code>quantity</code></td><td>Number</td><td>Usage amount</td></tr>
                            <tr><td><code>metering_pending</code></td><td>String</td><td>Must be <code>"true"</code> for new records</td></tr>
                        </tbody>
                    </table>

                    <h3>Node.js example</h3>

<pre><code>const { DynamoDBClient } = require('@aws-sdk/client-dynamodb');
const { DynamoDBDocumentClient, PutCommand } = require('@aws-sdk/lib-dynamodb');
const dynamodb = DynamoDBDocumentClient.from(new DynamoDBClient());

async function recordUsage(customerAWSAccountId, productCode,
                           dimension, quantity) {
    await dynamodb.send(new PutCommand({
        TableName: process.env.METERING_TABLE,
        Item: {
            customerAWSAccountId,
            productCode,
            create_timestamp: Date.now(),
            dimension,
            quantity,
            metering_pending: 'true'
        }
    }));
}

// Record 10 API calls for a customer
await recordUsage('123456789012', 'abc123xyz', 'api_calls', 10);

// Record 5 users for the same customer on a different product
await recordUsage('123456789012', 'def789uvw', 'users', 5);</code></pre>

                    <h3>Python example</h3>

<pre><code>import boto3
import time

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('YOUR_STACK_NAME-MeteringRecordsV2')

def record_usage(customer_aws_account_id, product_code,
                 dimension, quantity):
    table.put_item(
        Item={
            'customerAWSAccountId': customer_aws_account_id,
            'productCode': product_code,
            'create_timestamp': int(time.time() * 1000),
            'dimension': dimension,
            'quantity': quantity,
            'metering_pending': 'true'
        }
    )

# Record 100 GB of storage for a customer
record_usage('123456789012', 'abc123xyz', 'storage_gb', 100)

# Record 50 transactions on a different product
record_usage('123456789012', 'def789uvw', 'transactions', 50)</code></pre>

                    <h2>Metering dimensions</h2>

                    <p>Dimensions are the units you charge for. You define them when creating your AWS Marketplace product listing. The <code>dimension</code> field in your usage records must match exactly (case-sensitive). Common examples:</p>

                    <table>
                        <thead>
                            <tr><th>Dimension</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><code>users</code></td><td>Number of active users</td></tr>
                            <tr><td><code>api_calls</code></td><td>Number of API requests</td></tr>
                            <tr><td><code>storage_gb</code></td><td>Gigabytes of storage used</td></tr>
                            <tr><td><code>compute_hours</code></td><td>Hours of compute time</td></tr>
                            <tr><td><code>transactions</code></td><td>Number of transactions processed</td></tr>
                        </tbody>
                    </table>

                    <h2>Multi-product metering</h2>

                    <p>The metering pipeline supports multiple products from a single deployment. Each usage record includes a <code>productCode</code> field, and the hourly job aggregates records per product automatically. The <code>BatchMeterUsage</code> call is made with the correct product code for each batch.</p>

                    <p>You can query metering records for a specific product using the <code>ProductCodeIndex</code> GSI:</p>

<pre><code>aws dynamodb query \
    --table-name YOUR_STACK_NAME-MeteringRecordsV2 \
    --index-name ProductCodeIndex \
    --key-condition-expression "productCode = :code" \
    --expression-attribute-values '{":code":{"S":"abc123xyz"}}'</code></pre>

                    <h2>Monitoring</h2>

                    <h3>Check pending records</h3>

                    <p>Records waiting to be submitted:</p>

<pre><code>aws dynamodb query \
    --table-name YOUR_STACK_NAME-MeteringRecordsV2 \
    --index-name PendingMeteringRecordsIndex \
    --key-condition-expression "metering_pending = :p" \
    --expression-attribute-values '{":p":{"S":"true"}}'</code></pre>

                    <h3>Check failed records</h3>

                    <p>Records that failed to submit:</p>

<pre><code>aws dynamodb scan \
    --table-name YOUR_STACK_NAME-MeteringRecordsV2 \
    --filter-expression "metering_failed = :f" \
    --expression-attribute-values '{":f":{"BOOL":true}}'</code></pre>

                    <h3>View Lambda logs</h3>

<pre><code># Metering Job (hourly aggregation)
aws logs tail /aws/lambda/YOUR_STACK_NAME-MeteringJob --follow

# Metering Processor (BatchMeterUsage calls)
aws logs tail /aws/lambda/YOUR_STACK_NAME-MeteringProcessor --follow</code></pre>

                    <h3>Manually trigger the metering job</h3>

                    <p>For testing, you can invoke the metering job directly without waiting for the hourly schedule:</p>

<pre><code>aws lambda invoke \
    --function-name YOUR_STACK_NAME-MeteringJob \
    --payload '{}' \
    response.json</code></pre>

                    <h2>Handling failures</h2>

                    <p>When a <code>BatchMeterUsage</code> call fails, the affected records are marked with <code>metering_failed: true</code> and the error message is stored in <code>metering_response</code>. These records are not retried automatically.</p>

                    <p>To retry failed records, update them to reset the pending flag:</p>

<pre><code>aws dynamodb update-item \
    --table-name YOUR_STACK_NAME-MeteringRecordsV2 \
    --key '{"customerAWSAccountId":{"S":"123456789012"},"create_timestamp":{"N":"1708012345678"}}' \
    --update-expression "SET metering_pending = :p, metering_failed = :f" \
    --expression-attribute-values '{":p":{"S":"true"},":f":{"BOOL":false}}'</code></pre>

                    <p>The next hourly job will pick them up and try again.</p>

                    <div class="callout callout-warn">
                        <p><strong>Tip:</strong> Set up a CloudWatch alarm on the Metering Processor Lambda error count. This way you are notified if metering submissions start failing, rather than discovering it later.</p>
                    </div>

                    <h2>IAM permissions for your application</h2>

                    <p>Your application needs write access to the Metering Records table. Add this policy to the IAM role used by your application:</p>

<pre><code>{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "dynamodb:PutItem",
            "Resource": "arn:aws:dynamodb:REGION:ACCOUNT:table/STACK_NAME-MeteringRecordsV2"
        }
    ]
}</code></pre>

                    <h2>Best practices</h2>

                    <ul>
                        <li><strong>Record usage as it happens.</strong> Write records when events occur rather than batching them in your application. The hourly job handles aggregation for you.</li>
                        <li><strong>Use consistent dimension names</strong> across products when possible. This simplifies reporting and monitoring.</li>
                        <li><strong>Always include the <code>productCode</code> field.</strong> This allows the pipeline to handle multiple products correctly.</li>
                        <li><strong>Monitor failed records.</strong> Check periodically or set up alarms so failed submissions don't go unnoticed.</li>
                        <li><strong>Test before going live.</strong> Use the manual trigger to verify records flow through the pipeline correctly.</li>
                        <li><strong>Consider archiving old records.</strong> After AWS Marketplace confirms receipt, processed records can be moved to cold storage to keep table size manageable.</li>
                    </ul>

                    <h2>Cost</h2>

                    <p>The metering pipeline uses on-demand pricing across all resources:</p>

                    <ul>
                        <li><strong>DynamoDB:</strong> Pay per read/write. No traffic means no cost.</li>
                        <li><strong>Lambda:</strong> Two functions, invoked hourly plus per-message. Minimal at low volumes.</li>
                        <li><strong>SQS:</strong> First 1 million requests per month are free.</li>
                        <li><strong>CloudWatch Events:</strong> One rule, negligible cost.</li>
                    </ul>

                    <p>For most sellers, the metering pipeline costs less than $1/month until you have significant usage volume.</p>

                    <h2>Conclusion</h2>

                    <p>Usage metering on AWS Marketplace comes down to one integration point: writing records to a DynamoDB table. The pipeline deployed by the <a href="blog.html">registration page sample solution</a> handles aggregation, submission, tracking, and error handling automatically. Start by recording a few test records, trigger the metering job manually, and verify the results before going live.</p>

                    <p>For more information:</p>

                    <ul>
                        <li><a href="blog.html">Get Your AWS Marketplace SaaS Registration Page Live in Minutes</a></li>
                        <li><a href="https://docs.aws.amazon.com/marketplacemetering/latest/APIReference/API_BatchMeterUsage.html">BatchMeterUsage API Reference</a></li>
                        <li><a href="https://aws.amazon.com/blogs/awsmarketplace/step-by-step-guide-to-saas-integration-with-aws-marketplace/">Step-by-Step Guide to SaaS Integration with AWS Marketplace</a></li>
                        <li><a href="https://docs.aws.amazon.com/marketplace/latest/userguide/saas-products.html">AWS Marketplace Seller Guide: SaaS Products</a></li>
                    </ul>

                    <div class="author-box">
                        <h3>About the author</h3>
                        <div class="author-entry">
                            <div class="author-avatar">K</div>
                            <div class="author-info">
                                <div class="author-name">Kevin Kennedy</div>
                                <div class="author-title">Kevin is a Solutions Architect at Amazon Web Services, focused on helping ISV partners integrate with AWS Marketplace. He specializes in serverless architectures and developer tooling.</div>
                            </div>
                        </div>
                    </div>

                </div>
            </article>
        </main>

        <aside class="sidebar">
            <div class="sidebar-card">
                <h3>Related Posts</h3>
                <ul>
                    <li><a href="blog.html">Get Your AWS Marketplace SaaS Registration Page Live in Minutes</a></li>
                    <li><a href="https://aws.amazon.com/blogs/awsmarketplace/step-by-step-guide-to-saas-integration-with-aws-marketplace/">Step-by-Step Guide to SaaS Integration with AWS Marketplace</a></li>
                    <li><a href="https://aws.amazon.com/blogs/awsmarketplace/successfully-testing-your-saas-listing-in-aws-marketplace/">Successfully testing your SaaS listing in AWS Marketplace</a></li>
                </ul>
            </div>
            <div class="sidebar-card">
                <h3>Tags</h3>
                <div>
                    <a href="#" class="sidebar-tag">AWS Marketplace</a>
                    <a href="#" class="sidebar-tag">SaaS</a>
                    <a href="#" class="sidebar-tag">Metering</a>
                    <a href="#" class="sidebar-tag">DynamoDB</a>
                    <a href="#" class="sidebar-tag">Lambda</a>
                    <a href="#" class="sidebar-tag">SQS</a>
                    <a href="#" class="sidebar-tag">BatchMeterUsage</a>
                </div>
            </div>
            <div class="sidebar-card">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="https://docs.aws.amazon.com/marketplacemetering/latest/APIReference/">Metering API Reference</a></li>
                    <li><a href="https://aws.amazon.com/marketplace/management/products">Marketplace Management Portal</a></li>
                    <li><a href="https://github.com/aws-samples/aws-marketplace-serverless-saas-integration">Reference Implementation</a></li>
                </ul>
            </div>
        </aside>
    </div>

    <footer class="blog-footer">
        <div class="footer-inner">
            <p>&copy; 2026, Amazon Web Services, Inc. or its affiliates. All rights reserved.</p>
        </div>
    </footer>
</body>
</html>
